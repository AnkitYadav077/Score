<button id="payButton" data-user-id="4" data-cart-group-id="2">Pay Now</button>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById("payButton").onclick = async function() {
        const button = this;
        const userId = button.getAttribute('data-user-id');
        const cartGroupId = button.getAttribute('data-cart-group-id');
        const currency = "INR"; // currency ko fix kar diya yahan

        try {
            // Query params me cartId and currency bhej rahe hain (POST request with no body)
            const res = await fetch(`http://localhost:8080/api/payment/create?cartId=${cartGroupId}&currency=${currency}`, {
                method: 'POST'
                // No body needed as backend reads from query params
            });

            if (!res.ok) throw new Error("Failed to create payment order");
            const data = await res.json();

            const options = {
                key: "rzp_test_7SEhinYJRzQIpS",
                amount: data.amount,
                currency: data.currency,
                name: "Score App",
                description: "Food Order Payment",
                order_id: data.orderId,
                handler: async function (response) {
                    console.log("Payment Response:", response);

                    // Payment verification ke liye backend me cartId ko query param me bhej rahe hain
                    const verifyRes = await fetch(`http://localhost:8080/api/payment/verify?cartId=${cartGroupId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpayOrderId: response.razorpay_order_id,
                            razorpayPaymentId: response.razorpay_payment_id,
                            razorpaySignature: response.razorpay_signature,
                            userId: parseInt(userId),
                            amount: data.amount
                        })
                    });

                    const verifyData = await verifyRes.text();
                    if (!verifyRes.ok) throw new Error(verifyData);
                    alert(verifyData);
                },
                theme: { color: "#3399cc" }
            };

            const rzp = new Razorpay(options);
            rzp.open();

        } catch (error) {
            console.error(error);
            alert("Something went wrong! " + error.message);
        }
    };
</script>
